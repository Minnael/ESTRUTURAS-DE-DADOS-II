<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Rota em Tempo Real</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>#map { height: 100vh; }</style>
</head>
<body>
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
    let map = L.map('map').setView([-5.7945, -35.2110], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let rotaLayer;
    let origemMarker, destinoMarker;
    let ultimaPosicao = null;

    async function atualizarRotaComBase(posicao) {
        const coords = [posicao.coords.latitude, posicao.coords.longitude];

        // Só atualiza se mudou significativamente
        if (!ultimaPosicao || distancia(ultimaPosicao, coords) > 20) { // 20 metros de tolerância
            ultimaPosicao = coords;

            const response = await fetch(`/rota?lat=${coords[0]}&lng=${coords[1]}`);
            const data = await response.json();

            if (rotaLayer) map.removeLayer(rotaLayer);
            if (origemMarker) map.removeLayer(origemMarker);
            if (destinoMarker) map.removeLayer(destinoMarker);

            rotaLayer = L.polyline(data.caminho, { color: 'purple' }).addTo(map);
            origemMarker = L.marker(data.origem).addTo(map);
            destinoMarker = L.marker(data.destino).addTo(map);

            map.setView(coords, 15);
        }
    }

    // Calcular distância em metros entre duas coordenadas
    function distancia([lat1, lon1], [lat2, lon2]) {
        function toRad(x) { return x * Math.PI / 180; }
        const R = 6371000; // Raio da Terra em metros
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a = Math.sin(dLat/2) ** 2 +
                  Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                  Math.sin(dLon/2) ** 2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    if (navigator.geolocation) {
        navigator.geolocation.watchPosition(atualizarRotaComBase, console.error, {
            enableHighAccuracy: true,
            maximumAge: 1000,
            timeout: 5000
        });
    } else {
        alert("Geolocalização não é suportada pelo seu navegador.");
    }
</script>

</body>
</html>
